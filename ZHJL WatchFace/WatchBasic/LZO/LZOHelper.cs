using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using WatchBasic.Tool;

namespace WatchBasic.LZO
{
    public class LZOHelper
    {
        public static byte[] mergeDialFile(byte[] src)
        {
           
            var segmentLength = 4 * 1024;//压缩块长度
            var head = new List<byte>();//头
            var num = 0xAFAFAF02;
            //文件标识
            head.AddRange(num.GetBytes32(true));
            //压缩前大小
            head.AddRange(src.Length.GetBytes32());
            //压缩前校验
            head.AddRange(GetOther(src));

            var mainbytes = new List<byte>();
            var remainder = src.Length % (segmentLength);
            var quotient = src.Length / (segmentLength);
            var divideFileNum = remainder == 0 ? quotient : quotient + 1;
            mainbytes.AddRange(divideFileNum.GetBytes16());
            var filebytes = new List<byte>();
            for (var index = 0; index < divideFileNum; index++)
            {
                var temp = src.Skip(index * segmentLength).Take(segmentLength);
                var compress = MiniLZO.Compress(temp.ToArray());
                int iscompress = 1;
                var size = 0;
                if (compress.Length > temp.Count())
                {
                    iscompress = 0;
                    size = temp.Count();
                    filebytes.AddRange(temp);
                }
                else
                {
                    size = compress.Length;
                    filebytes.AddRange(compress);
                }
                var fileSizeInfo = (iscompress << 15) + size;
                mainbytes.AddRange(fileSizeInfo.GetBytes16());
            }
            head.AddRange(filebytes.Count.GetBytes32());//压缩后长度
            head.AddRange(GetOther(filebytes.ToArray())); //CRC
            head.AddRange(0.GetBytes32());//保留位
            head.AddRange(mainbytes);
            head.AddRange(filebytes);
            return head.ToArray();

        }

        //uint32_t OTHER_FLASH_CRC_Dial(uint8_t* bytes, uint16_t num, uint32_t crc)
        //{
        //    uint16_t i;

        //    for (i = 0; i < num; i++)
        //    {
        //        crc = ((crc >> 8) & 0x00ffffff) ^ chafenbao_32_dial[(crc ^ bytes[i]) & 0xff];
        //    }

        //    return crc;
        //}
        //3548B4C0

        //bytes/1024
        //public static uint OTHER_FLASH_CRC_Dial(byte[] bytes)
        //{

        //    var segmentLength = 1024;
        //    var remainder = bytes.Length % (segmentLength);
        //    var quotient = bytes.Length / (segmentLength);
        //    var divideFileNum = remainder == 0 ? quotient : quotient + 1;
        //    uint crc = 0xffffffff;
        //    for (var index = 0; index < divideFileNum; index++)
        //    {
        //        var temp1 = bytes.Skip(index * segmentLength).Take(segmentLength).ToArray();
        //        for (var i = 0; i < temp1.Length; i++)
        //        {
        //            crc = ((crc >> 8) & 0x00ffffff) ^ chafenbao_32_dial[(crc ^ temp1[i]) & 0xff];
        //        }
        //    }
        //   // var temp = BitConverter.ToUInt32(BitConverter.GetBytes(crc).Reverse().ToArray());

        //    return crc;
        //}

        public static byte[] GetCRCM65A(byte[] bytes)
        {
            return GetCRC(bytes, m65A);
        }

        public static byte[] GetOther(byte[] bytes) 
        {
            return GetCRC(bytes, another);
        }

        static byte[] GetCRC(byte[]bytes,uint[] tables) 
        {
            long crc = 0xffffffff;
            foreach (byte b in bytes)
            {
                crc = ((crc >> 8) & 0x00ffffff) ^ tables[((int)crc ^ b) & 0xff];
            }
            // flip bits
            crc = ~crc;
            byte[] result_bytes = new byte[4];

            result_bytes[0] = (byte)crc;
            result_bytes[1] = (byte)(crc >> 8);
            result_bytes[2] = (byte)(crc >> 16);
            result_bytes[3] = (byte)(crc >> 24);
            return result_bytes;
        }


        public static uint[] m65A => new uint[]
        {
           281233934, 654117070, 3236494948, 1962469351, 2422755260, 1962060297, 4109789052, 2495887132, 3349395785, 3807498825, 4147392729, 1338337615, 4210607740, 4002502406, 618644983, 3689026186, 1737459875, 1940712725, 3440507702, 347392801, 1099336126, 2615281589, 3211314658, 694848599, 1329212063, 3158202680, 582062455, 3104172638, 4125625679, 1118998233, 474926060, 283541754, 901605776, 918002975, 4114895749, 1073303182, 3506942434, 2523966937, 2933149395, 380654311, 3743066953, 1095588451, 2639237362, 988722692, 3383765722, 1970405101, 1340980545, 2765116599, 3746584330, 2104366547, 2517091373, 2831878279, 1946870839, 1763425552, 2408954115, 2286979222, 3234308532, 3847107231, 4076999156, 1504655602, 1873132995, 1871481870, 705489870, 3459407809, 1050329215, 1460915055, 2486404243, 1866191211, 1936657029, 931955905, 1680875607, 2482893172, 1861172672, 1440621832, 1229359949, 2085064903, 3769654547, 1933804952, 2146248753, 606496006, 1790000298, 1106610020, 3023975831, 4286056407, 2267134510, 4005449710, 1364627059, 1630139823, 4008404916, 3558536343, 3573037851, 3398536211, 3058757014, 2788813225, 3901870828, 2830785699, 3198283787, 3586986752, 3573333868, 658686947, 1450613396, 477167310, 349956514, 1838138303, 1026037143, 2153226209, 1760075343, 707793082, 3053835523, 2220503557, 421789312, 2453937816, 1509474315, 3180581129, 571761322, 1712598131, 1425984383, 4127887183, 2112860310, 2337309582, 906600572, 3667222800, 436795693, 3538776394, 3840600302, 3472350342, 3730709011, 1295322472, 2933167942, 818169416, 1811798643, 1796022755, 1147720715, 3560761836, 1650671278, 2506975123, 1424798585, 2170194889, 1030305067, 1429429228, 3549763957, 602434355, 2519947237, 358395839, 3359139214, 3423244534, 3189905453, 2052708254, 2732626332, 2956771204, 2611102570, 1055121406, 4181709867, 3864969308, 2649354756, 759631253, 2076406079, 3306972203, 1576473511, 3403578673, 3920161971, 3217700248, 3254749128, 3603966328, 1244883722, 633121664, 441277445, 1675847560, 780358057, 2889852795, 1324818258, 2900583189, 964625512, 1604796583, 2679038868, 2624878559, 422079283, 3564716311, 1653280699, 1714426659, 3807116114, 3687758937, 2996367699, 738973898, 3610221008, 4266608537, 4018033122, 957261294, 388056539, 645566222, 2928628781, 421573883, 2368323155, 1387175445, 3754740926, 3955361152, 3143971764, 2082724353, 2207415306, 1876323894, 1822693170, 3388173130, 2260364896, 2101159392, 1905662047, 2179291489, 1708556750, 424531005, 2426215910, 357172192, 1763635124, 1946010759, 2678178327, 3115981619, 3770918617, 1290086536, 2520824205, 3042038899, 414353200, 1601985299, 2443601974, 3554136038, 472298063, 3622235860, 2384954027, 4086521048, 2365435015, 4011305856, 4291139995, 2389803319, 1634107817, 3698052795, 3689835849, 1146768742, 1418596261, 4192916740, 4127656180, 1894463512, 2660508101, 4289413654, 1921300321, 4261170937, 4232452119, 1857592316, 2646222278, 511052013, 945682697, 3381683596, 659141913, 3801415211, 2289705036, 1841379976, 4282181814, 3172798148, 1971856564, 3828682070, 2804229525, 1282594158, 283374847, 938584184, 3648298964, 1098846516, 3071587347, 3691471520, 2061950239, 4287816703, 4266852197, 3058876732, 2299679849, 509575048, 1651019366, 2760999125, 2715036407, 3603788744, 956268637, 283308606, 3295088322, 1427589593, 4090159415, 2013047952, 3824421899, 3420342478, 3740257181, 2563893579, 2443005206, 1694445974, 333527421, 858093951, 283012781, 2234441902, 1042462242, 1117668093, 3155948018, 2888920921, 1630588881, 2310000149, 3039305972, 1091953995, 2582521519, 3682871310, 2683900023, 1525644018, 3073775873, 2124072238, 3892083435, 1285909563, 4184284629, 560432198, 3458119844, 3691631453, 2645867771, 3095337003, 2492987287, 4131634899, 3719928781, 2203283615, 4152336757, 2834032881, 1578453364, 950189128, 1666641968, 582012108, 1313192329, 1424797300, 3433594289, 3810623209, 3075514454, 4282355972, 2016267975, 2047433384, 2144256452, 1561522058, 2756713858, 4283235325, 3120181997, 3559377474, 2319313824, 504674466, 2617841381, 1600396804, 2716788073, 441642512, 2408821910, 1561649909, 3574011185, 598890365, 356128985, 2725706181, 1951732209, 2852621813, 4193159456, 308632723, 330678985, 996061859, 313413425, 1384136257, 2415065972, 1789595637, 4257585567, 4220917803, 1227887628, 4267745457, 1639516869, 4224794590, 2111562327, 2914304289, 572563631, 3345924233, 3060969032, 3539789888, 2335503926, 1522602443, 2040323447, 707308852, 3654138613, 1496191536, 496719232, 3747826733, 691587227, 1407621837, 384856886, 694039390, 330661948, 1856862383, 841040195, 2699436131, 3814586408, 645459538, 2233741967, 1313940379, 731559445, 523187335, 3495216835, 3386524941, 2943271479, 501117520, 1210565532, 1471750217, 2998176529, 3997562999, 2842895652, 1574091626, 2792554505, 3668348329, 380919429, 828851211, 3258774550, 2870065676, 3283968712, 1568973046, 1166718807, 2352655335, 2043176084, 3397065972, 472835984, 2519700278, 2436128223, 830356406, 731836187, 3459054772, 1093291673, 2928187062, 1960220831, 844377193, 3107310552, 3913427098, 3429419170, 2367448711, 3017365258, 569020259, 2448946842, 3029940182, 1756191488, 2274029648, 1471497035, 2464210862, 1809501911, 1743010057, 2604573688, 3900011809, 2519122695, 2652168266, 3678636229, 2310234369, 1306795224, 1961829885, 3833029811, 1425034941, 4162757206, 2372806688, 3691120164, 816795649, 1924578635, 3697322601, 1332238721, 2516023094, 2813051345, 2639084321, 916572471, 1937946051, 1566108663, 4277642331, 2861880478, 3345455011, 2004366946, 587106116, 3364399781, 2660896641, 1588263155, 356061316, 609990433, 364873362, 3929344809, 1624238036, 2702818397, 3731479252, 311755740, 455900393, 3082625958, 2289401582, 1386352060, 1946871015, 1460088680, 464204563, 1410984510, 1375230316, 2712530106, 3906256228, 3897845556, 2552226242, 3087765285, 1735517719, 3512201651, 2364487489, 2720229794, 4094010932, 3500863746, 2814803577, 3110612910, 847966071
        };

        public static uint[] another => new uint[]
        {
            1615151721, 1186549704, 3897229116, 2437668236, 3575590607, 1886181906, 1900795753, 4098871561, 1974169757, 958588230, 2575554029, 3771617949, 3580748672, 3694713694, 1662478301, 457827557, 3870987191, 2963135019, 2478044409, 2900136861, 2676905177, 990153219, 3419046402, 3307485715, 623318543, 3614721833, 2331755413, 2928013718, 494151368, 1025940958, 3319369849, 803999316, 2080738846, 4263245546, 2605329119, 1479047010, 2935278131, 2647107576, 2999922017, 1966906953, 1411748149, 3340230423, 1989273731, 3966261817, 4074581376, 1705824216, 3831605302, 1782359828, 652781636, 327111990, 3512682440, 1731850944, 1374007646, 908890328, 2569597458, 1223585911, 3551461474, 3413625834, 3208458244, 3785384131, 3536924322, 610734351, 3713191480, 2769165111, 540521717, 2595926657, 1938532971, 3958779636, 2363602919, 2667433378, 1498201691, 336544994, 958357006, 1425853394, 2553728603, 589157506, 893729024, 626205916, 372834284, 461819294, 4226535950, 2624764003, 4241363972, 3662497732, 1697458050, 2825607111, 2469864203, 746635318, 2287488413, 2780790933, 509209437, 3220480502, 3576915584, 459700923, 4261427995, 1272706512, 1184183626, 1186729382, 586686421, 3704118413, 3310955078, 553796546, 4174258250, 1436740827, 808362987, 584832512, 1700307582, 540800245, 1760340196, 1223162650, 2434716503, 3664403389, 4021510003, 723924002, 634252741, 462922073, 1910941840, 2354552572, 4245108385, 2154345067, 2407141880, 1794052843, 3958999888, 2935350101, 2144961929, 1649005597, 1565579339, 2466959156, 4239356348, 4220168934, 928020413, 4021946758, 2865728838, 2146371947, 2388280546, 2327386616, 3303609299, 1568428218, 3416395488, 2900196861, 2027746117, 4237580166, 2336945061, 3777684378, 3833111860, 3727220002, 579331838, 2775695170, 3424162465, 1860539243, 3735246059, 1149486466, 3597004956, 2129859827, 858622420, 954733868, 4192330472, 1376556107, 3051107806, 1838735073, 689453498, 3051072176, 3234720110, 1058437337, 2336847205, 1845131637, 4239891376, 1769441682, 394543888, 2554788839, 2975170458, 958683795, 1969241929, 1543871190, 368462196, 3523402659, 2009425124, 1172308400, 3162961384, 3628444653, 2159705445, 4133233706, 1641008776, 1760871057, 2792260104, 3667983608, 3574678816, 2768794223, 3095662429, 1946062361, 3335471017, 3436431652, 3946118318, 1576621561, 4119774122, 355228228, 2253452542, 3414012115, 350875648, 1010525652, 668733847, 1408701766, 1604902562, 2417877622, 3021528228, 4175056445, 840759036, 1612248028, 4118426431, 1431985376, 964302630, 358739876, 1484217416, 3305509766, 3326391865, 2418680770, 1358875525, 2062597922, 2397140779, 4003788856, 3439733401, 3823925406, 2060484990, 836140273, 2494273237, 466191524, 3144261599, 1479675548, 4129170644, 3919945646, 2590769776, 2369340851, 2871245592, 3005826919, 3495199415, 2468255218, 2954410756, 1342037823, 2915631804, 302974167, 897550671, 1502195761, 710727238, 2258210957, 4130036818, 2329016059, 4232962278, 838175687, 2361575348, 3690078925, 377099141, 1475320052, 2353779246, 1147836896, 2451021480, 860575240, 440833399, 2526003110, 3107458252, 1767710524, 1542643659, 1473168671, 446453188, 1377643759, 3945824684, 4026247590, 2173207744, 3002840948, 3639070851, 770918981, 3780968994, 2152512081, 2538910541, 938726555, 3882656537, 2747396239, 1468261410, 2657726131, 902908921, 836137091, 440886922, 1262063445, 3389479013, 3829982987, 590470464, 356619171, 371090170, 3775667449, 600336931, 1295510451, 2767062531, 872002944, 3967188644, 3486505427, 2360509492, 629697015, 812581671, 3303076703, 1257449001, 1855601275, 759577537, 2360958703, 2452887945, 3025882881, 3056027676, 3499556555, 2118142257, 495321214, 2563950372, 678166299, 3487435862, 2665373520, 1092818394, 3877217711, 961575260, 3532308377, 4030688677, 308525240, 1350895380, 4156688162, 966556607, 513864671, 2676967733, 1408862643, 3208955631, 861244373, 3571959804, 1136830195, 1952519924, 3670606965, 995082198, 3335718871, 743754862, 1477798588, 3166270386, 2429145287, 324077357, 2967409797, 2270617286, 2267570747, 3584968083, 3520683439, 1171576548, 328548681, 3387627177, 3471698709, 2739310140, 3183041392, 4071380545, 4039131190, 981400880, 3762385510, 4122700486, 568816725, 896069581, 1283641853, 3893785488, 1873059999, 378434251, 4186774778, 1088977094, 945454833, 3535961566, 1560407201, 3065875412, 3986268015, 1102244977, 2782802382, 2250967970, 3904709653, 2844037513, 2402580943, 2469045775, 578862540, 2385126053, 510011403, 2284376713, 2186568351, 4176009058, 4023812689, 3969561763, 3460934626, 2514048904, 3560633922, 2259777466, 3360292497, 1921993937, 869566122, 2486043023, 452309222, 3449871544, 2644537841, 1030705431, 3455659358, 597328304, 3229841427, 2216724901, 2986397385, 757421295, 3326499219, 3527894526, 2447441382, 2711861171, 3680678310, 1296499307, 2227286734, 4218195754, 1743386730, 3329315591, 4015396296, 2687042037, 758990508, 2290335184, 2073413672, 3661984510, 3735564444, 4124581039, 3097950021, 2772019360, 1328195177, 1794617362, 1623184181, 1571137672, 564268510, 2886778303, 1139706720, 1501194900, 2924805001, 1323765549, 3545690901, 1868225040, 752502539, 1947278355, 1387170270, 745014077, 1005860431, 878318714, 2912081525, 348308076, 1943846851, 2922935526, 3642238344, 1384851436, 3668470779, 3789012552, 1917483243, 3265503695, 3641007958, 2643437298, 3244350105, 1272559712, 1104522698, 979713057, 2901554581, 1799271061, 3255328557, 954432654, 2523933707, 885334656, 2821456377, 1433151445, 383611754, 2389832546, 1775610428, 296774989, 539102107, 3904519566, 521056822, 2359371005, 1722438006, 2031350090, 3775002686, 3197307453, 2498970051, 1002819591, 1700458328, 1642225219, 819977130, 638161390, 3364551152, 1225943602, 2605945220, 3722297384, 3732156627, 4117479036, 2375294339, 453858583, 1496470058, 3824107694, 2031982543, 512963434, 748607608, 2066033081, 1422738895, 3318362092, 1647550460, 468653815, 2876252792, 2227088886, 3755197727
        };

    }
}
