Ì£..# ðŸš€ Quick Start Guide - Backend MOY Generation

## What Changed?

MOY file generation has been moved from the frontend (browser) to a backend server using Node.js, **exactly matching the vendor's implementation**. This ensures proper binary format handling.

## Setup Steps (3 minutes)

### Step 1: Install Backend Dependencies

Open PowerShell in the project root:
Ì£
```powershell
cd server
npm install
```

### Step 2: Start the Backend Server

```powershell
npm start
```

You should see:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   MOY Generator Backend Server         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸš€ Server running at http://localhost:3001
```

**âœ¨ Tip:** Use `.\start.ps1` for a quick start script!

### Step 3: Test the Backend (Optional)

In a new terminal:

```powershell
cd server
npm test
```

You should see:
```
ðŸ§ª Testing MOY Generator Backend

1ï¸âƒ£  Testing health endpoint...
   âœ… Health check passed

2ï¸âƒ£  Testing MOY generation...
   âœ… MOY generation successful

3ï¸âƒ£  Verifying MOY file structure...
   âœ… MOYEND marker found
   âœ… IMGEND marker found
   âœ… JSON structure valid

âœ… All tests passed!
```

### Step 4: Start the Frontend

In a new terminal, from project root:

```powershell
npm run dev
```

**That's it!** The frontend will now use the backend for MOY generation.

## How to Use

Everything works the same from the user's perspective:

1. Design your watch face in the UI
2. Click "Export MOY" button
3. The frontend sends data to the backend
4. Backend generates the MOY file using Node.js fs APIs
5. MOY file downloads automatically

## Console Output

### Frontend Console
```
=== Preparing MOY Export (Backend Mode) ===
Watch name: MyWatch
Layer groups: 5
  Prepared image: bg.png (15234 bytes)
  ...

ðŸ“¤ Sending request to backend: http://localhost:3001/api/generate-moy

âœ… MOY file generated by backend
   Filename: MyWatch_1736236800000.moy
   Size: 187456 bytes
```

### Backend Console
```
ðŸ“¥ Received MOY generation request
   Watch name: MyWatch
   Layer groups: 5
   Images received: 12

âœ“ Written JSON data: 5678 bytes
âœ“ Written MOYEND delimiter
  âœ“ Written image 1: bg.png
  ...
âœ“ MOY file generated successfully
  Total images: 12

ðŸ“¤ Sending MOY file: 187456 bytes
```

## Vendor Code Implementation

The backend uses **exactly** the vendor's approach:

```typescript
// Vendor code structure (translated to TypeScript):
const fileHandle = openSync(filename, 'w+');
writeSync(fileHandle, JSON.stringify(moyFile));
writeSync(fileHandle, 'MOYEND');

layerGroups.forEach(layer => {
  layer.nodeAttr.selectImg.forEach(img => {
    const data = readFileSync(img.url, 'binary');
    writeSync(fileHandle, data);
    writeSync(fileHandle, 'IMGEND');
  });
});

closeSync(fileHandle);
```

## Troubleshooting

### Backend won't start

**Error:** `Cannot find module 'express'`

```powershell
cd server
npm install
```

### Frontend can't connect

**Error:** `Backend MOY generation failed`

1. Make sure backend is running on port 3001
2. Test with: `curl http://localhost:3001/api/health`
3. Check firewall settings

### Images still corrupted

The backend uses native Node.js binary I/O, matching the vendor exactly. If still seeing issues:

1. Check backend logs for errors
2. Verify image sizes in console output
3. Check PNG signatures are valid

## File Locations

```
project-root/
â”œâ”€â”€ server/                    # Backend server
â”‚   â”œâ”€â”€ moyServer.ts          # Main server (matches vendor code)
â”‚   â”œâ”€â”€ package.json          # Backend dependencies
â”‚   â”œâ”€â”€ start.ps1             # Quick start script
â”‚   â”œâ”€â”€ test-backend.js       # Test script
â”‚   â””â”€â”€ temp/                 # Generated MOY files
â”‚
â””â”€â”€ src/utils/
    â””â”€â”€ MoyGenerator.ts       # Updated to use backend API
```

## Development Mode

For development with auto-reload:

```powershell
cd server
npm run dev
```

Server will restart automatically when you change code.

## What's Next?

The backend is ready to use! For production deployment, see [BACKEND_SETUP.md](BACKEND_SETUP.md).

## Benefits

âœ… **Exact vendor match** - Uses same Node.js fs APIs
âœ… **Reliable binary** - Native file I/O, no browser limits  
âœ… **Proper format** - Guaranteed compatibility
âœ… **Better debugging** - Full server logs
âœ… **Scalable** - Can handle large files
âœ… **Future-proof** - Easy to add validation, authentication, etc.

## Support

If you run into issues:

1. Check both frontend and backend console logs
2. Run `npm test` in the server directory
3. Verify Node.js version (18+ recommended)
4. Check port 3001 isn't being used by another app

---

**Ready to generate MOY files? Start the backend and you're good to go! ðŸŽ‰**
